<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Future Levee Predictor</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/chartjs-plugin-annotation@1.1.0"></script>
  <style>
    /* styles same as your original */
  </style>
</head>
<body>
<div class="container">
  <div class="sidebar">
    <h2 class="levee-title">Levee Predictor</h2>
    <select class="levee-select" onchange="selectLevee(this.value)">
      <option value="">Select site</option>
      <option value="Site 2">Site 2</option>
      <option value="Site 3">Site 3</option>
      <option value="Site 4">Site 4</option>
    </select>
    <div class="water-table-wrapper">
      <table id="water-table"></table>
    </div>
    <button class="predict-btn" onclick="predict()">Predict</button>
    <div id="loading-message" style="display:none; margin-top:2px; text-align:center; color:gray;">Please wait...</div>
    <div id="predict-result" class="predict-result">
      <canvas id="chartCanvas" width="400" height="300"></canvas>
      <button class="download-btn" onclick="downloadChart()">Download Chart</button>
      <div id="summary" style="margin-top:2px; font-size:16px;"></div>
    </div>
  </div>
  <div class="map-container">
    <div id="map"></div>
  </div>
</div>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
// === Your utility and setup functions (selectLevee, initializeTable, etc.) ===
// ... unchanged from your version

function predict() {
  const waterDataOriginal = getTableData();
  if (waterDataOriginal.length !== 20) {
    alert('Please enter exactly 20 water level values.');
    return;
  }
  const waterData = interpolateWaterLevels(waterDataOriginal);
  const baseURL = location.hostname === "localhost"
    ? "http://localhost:8080"
    : "https://leveepredictor-production.up.railway.app/";
  const loadingDiv = document.getElementById('loading-message');
  const predictBtn = document.querySelector('.predict-btn');
  loadingDiv.style.display = 'block';
  predictBtn.disabled = true;
  predictBtn.innerText = 'Predicting...';

  fetch(`${baseURL}/predict`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ water_levels: waterDataOriginal })
  })
  .then(response => response.json())
  .then(data => {
    loadingDiv.style.display = 'none';
    predictBtn.disabled = false;
    predictBtn.innerText = 'Predict';
    if (data.error) return alert("‚ö†Ô∏è Error: " + data.error);

    document.getElementById('predict-result').style.display = 'block';
    const ctx = document.getElementById('chartCanvas').getContext('2d');
    if (window.chart) window.chart.destroy();

    const labels = Array.from({ length: 40 }, (_, i) => (i + 1) / 2);
    const fs1Data = data.fs1.map((v, i) => ({ x: labels[i], y: v }));
    const fs2Data = data.fs2.map((v, i) => ({ x: labels[i], y: v }));
    const waterLevelData = data.water_level.map((v, i) => ({ x: labels[i], y: v }));

    window.chart = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [
          { label: 'Toe of Levee', data: fs1Data, borderColor: '#cc0000', borderWidth: 1.5, pointRadius: 2, tension: 0.4 },
          { label: 'Toe of Berm', data: fs2Data, borderColor: '#666666', borderWidth: 1.5, pointRadius: 2, tension: 0.4 },
          { label: 'Water Level (ft)', data: waterLevelData, borderColor: 'lightblue', borderWidth: 1.5, pointRadius: 0, tension: 0.4, yAxisID: 'y1' }
        ]
      },
      options: {
        scales: {
          x: { type: 'linear', title: { display: true, text: 'Day' }, min: 1, max: 20 },
          y: { min: 0, max: 4, title: { display: true, text: 'FS' }, position: 'left' },
          y1: { type: 'linear', position: 'right', title: { display: true, text: 'Water Level (ft)' }, grid: { drawOnChartArea: false } }
        },
        plugins: { annotation: { annotations: { line1: { type: 'line', yMin: 1, yMax: 1, borderColor: 'red', borderDash: [6, 6], borderWidth: 1 } } } }
      }
    });

    const summary = document.getElementById('summary');
    const fs1Danger = data.fs1.findIndex(v => v < 1);
    const fs2Danger = data.fs2.findIndex(v => v < 1);
    const firstDangerDay = Math.min(
      fs1Danger >= 0 ? (fs1Danger + 1) / 2 : Infinity,
      fs2Danger >= 0 ? (fs2Danger + 1) / 2 : Infinity
    );
    const peakWater = Math.max(...data.water_level);
    let floodStage = peakWater >= 30 ? "üö® Major" : peakWater >= 28 ? "‚ö†Ô∏è Moderate" : peakWater >= 22 ? "üåß Minor" : "‚úÖ Normal";
    let recommendation = peakWater >= 30 ? "Rockfill and pumps." : peakWater >= 28 ? "Sandbags and watch." : "Monitor regularly.";
    let zone = [];
    if (fs1Danger >= 0) zone.push("toe of levee");
    if (fs2Danger >= 0) zone.push("toe of berm");

    const msgImg = `<div style='text-align:center'><img src='/static/images/levee_schematic.png' style='max-width:100%; height:auto; border:1px solid #ccc; border-radius:2px;'></div>`;

    summary.innerHTML =
      firstDangerDay < Infinity
      ? `${msgImg}<span style='color:red;font-weight:bold;'>‚ö†Ô∏è Seepage Risk Detected</span><br><span style='color:gray;'>First issue: <b>Day ${firstDangerDay}</b> at <b>${zone.join(" and ")}</b>. Flood Stage: <b>${floodStage}</b><br><b>Do this:</b> ${recommendation}</span>`
      : `${msgImg}<span style='color:green;font-weight:bold;'>‚úÖ Safe</span><br><span style='color:gray;'>No stability issues detected. Go ahead and get coffee.</span>`;
  });
}

function downloadChart() {
  const link = document.createElement('a');
  link.download = 'levee_prediction_chart.png';
  link.href = chart.toBase64Image();
  link.click();
}

initializeTable();
</script>
</body>
</html>
